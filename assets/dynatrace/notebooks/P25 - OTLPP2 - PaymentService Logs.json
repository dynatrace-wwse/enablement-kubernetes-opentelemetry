{
    "version": "7",
    "defaultTimeframe": {
        "from": "now()-2h",
        "to": "now()"
    },
    "defaultSegments": [],
    "sections": [
        {
            "id": "75c4b627-93f0-4f77-816f-93bd040bea83",
            "type": "markdown",
            "markdown": "# Payment Service Logs\n##### This Notebook will be used to analyze the payment logs, see how the changes we make affect the logs and how we can analyze those logs."
        },
        {
            "id": "ff8bfc8d-23b6-420e-bb32-12d7aee21009",
            "type": "markdown",
            "markdown": "### Run the query below and explore the logs to see what metadata exists, there are a few key things to notice in the logs. After we configured our collectors, our logs have all the k8s attributes, as well as the trace_id and span_id. \n\n### Right now, the loglevel and status are set to NONE. Since Pino (node.js logger) sends the log level as a number (30) that is not automatically interpreted to set the log status. You may also notice these logs contain payment information and sensitive data that we should handle. "
        },
        {
            "id": "31ff4ca3-9c8f-4614-9101-f451df5f4011",
            "type": "dql",
            "title": "Explore PaymentService logs",
            "queryConfig": {
                "version": "19.0.0",
                "subQueries": [
                    {
                        "id": "A",
                        "isEnabled": true,
                        "datatype": "logs",
                        "filter": "k8s.namespace.name = astronomy-shop k8s.container.name = paymentservice "
                    }
                ],
                "globalCommands": {
                    "limit": 10,
                    "sort": {
                        "field": "timestamp",
                        "direction": "desc"
                    }
                }
            },
            "filterSegments": [],
            "drilldownPath": [],
            "previousFilterSegments": [],
            "previousQueryConfig": {
                "version": "19.0.0",
                "subQueries": [
                    {
                        "id": "A",
                        "isEnabled": true,
                        "datatype": "logs",
                        "filter": "k8s.namespace.name = astronomy-shop k8s.container.name = paymentservice "
                    }
                ],
                "globalCommands": {
                    "limit": 10,
                    "sort": {
                        "field": "timestamp",
                        "direction": "desc"
                    }
                }
            },
            "state": {
                "input": {
                    "timeframe": {
                        "from": "now()-30m",
                        "to": "now()"
                    },
                    "value": "fetch logs\n| filter matchesValue(k8s.namespace.name, \"astronomy-shop\") AND matchesValue(k8s.container.name, \"paymentservice\")\n| sort timestamp desc\n| limit 10"
                },
                "visualizationSettings": {
                    "chartSettings": {}
                },
                "querySettings": {
                    "maxResultRecords": 1000,
                    "defaultScanLimitGbytes": 500,
                    "maxResultMegaBytes": 1,
                    "defaultSamplingRatio": 10,
                    "enableSampling": false
                },
                "davis": {
                    "includeLogs": true,
                    "davisVisualization": {
                        "isAvailable": true
                    }
                }
            }
        },
        {
            "id": "a375b58d-1608-47ed-bacc-b82e19e8ee41",
            "type": "markdown",
            "markdown": "## We are going to create a pipeline in OpenPipeline to modify our logs to fit the needs of the paymentservice team."
        },
        {
            "id": "3ac77860-b345-4df6-9e0f-70bfa3d52c7d",
            "type": "markdown",
            "markdown": "### After we have added the technology bundle for Node.JS into OpenPipeline, let's see what has changed in our logs."
        },
        {
            "id": "95ef2870-1887-49e9-9b14-947df5ca1513",
            "type": "dql",
            "filterSegments": [],
            "drilldownPath": [],
            "previousFilterSegments": [],
            "state": {
                "input": {
                    "timeframe": {
                        "from": "now()-30m",
                        "to": "now()"
                    },
                    "value": "fetch logs\n| filter k8s.namespace.name == \"astronomy-shop\" and k8s.container.name == \"paymentservice\"\n| sort timestamp desc\n| limit 10"
                },
                "visualizationSettings": {
                    "chartSettings": {}
                },
                "querySettings": {
                    "maxResultRecords": 1000,
                    "defaultScanLimitGbytes": 500,
                    "maxResultMegaBytes": 1,
                    "defaultSamplingRatio": 10,
                    "enableSampling": false
                },
                "davis": {
                    "includeLogs": true,
                    "davisVisualization": {
                        "isAvailable": true
                    }
                }
            }
        },
        {
            "id": "f37b49e7-597b-46dd-9dba-18a774531711",
            "type": "markdown",
            "markdown": "## You should now see that the loglevel and status is set to INFO. You should also now have a host.name field that is extracted from the logs, as well as a message field and the process.pid.\n\n## Next we are going to parse the content and flatten the JSON so it is easier to work with."
        },
        {
            "id": "368b9e19-6f56-4445-bb23-efa3802e6342",
            "type": "dql",
            "filterSegments": [],
            "drilldownPath": [],
            "previousFilterSegments": [],
            "state": {
                "input": {
                    "timeframe": {
                        "from": "now()-30m",
                        "to": "now()"
                    },
                    "value": "fetch logs\n| filter k8s.namespace.name == \"astronomy-shop\" and k8s.container.name == \"paymentservice\"\n| sort timestamp desc\n| limit 10"
                },
                "visualizationSettings": {
                    "chartSettings": {}
                },
                "querySettings": {
                    "maxResultRecords": 1000,
                    "defaultScanLimitGbytes": 500,
                    "maxResultMegaBytes": 1,
                    "defaultSamplingRatio": 10,
                    "enableSampling": false
                },
                "davis": {
                    "includeLogs": true,
                    "davisVisualization": {
                        "isAvailable": true
                    }
                }
            }
        },
        {
            "id": "4d6f6fdf-5f62-47db-825e-babc1a172351",
            "type": "markdown",
            "markdown": "### You should see the new fields created on the logs that start with \"content.*\" up to 3 fields deep making the data much easier to analyze and access. Now that we have these fields, we will get rid of the original content field that was bloated and full of JSON. Instead we will replace it with the Message field, and still have the rest of the information retained in fields such as content.cardType"
        },
        {
            "id": "7bd1e285-9df1-42df-8c2d-463577e51998",
            "type": "dql",
            "filterSegments": [],
            "drilldownPath": [],
            "previousFilterSegments": [],
            "state": {
                "input": {
                    "timeframe": {
                        "from": "now()-30m",
                        "to": "now()"
                    },
                    "value": "fetch logs\n| filter k8s.namespace.name == \"astronomy-shop\" and k8s.container.name == \"paymentservice\"\n| sort timestamp desc\n| limit 10\n| fieldsKeep content, loglevel, \"content.*\""
                },
                "visualizationSettings": {
                    "chartSettings": {}
                },
                "querySettings": {
                    "maxResultRecords": 1000,
                    "defaultScanLimitGbytes": 500,
                    "maxResultMegaBytes": 1,
                    "defaultSamplingRatio": 10,
                    "enableSampling": false
                },
                "davis": {
                    "includeLogs": true,
                    "davisVisualization": {
                        "isAvailable": true
                    }
                }
            }
        },
        {
            "id": "8d99c5ae-8c51-4d83-b91c-e54cbcfd781f",
            "type": "markdown",
            "markdown": "## The logs should be much easier to read now as the content should just mentioned what happened during that log. On the logs where the transaction is complete, lets extract all the payment information and make that easy to work with."
        },
        {
            "id": "904c2b46-6832-4985-8dcf-7dc8288239ea",
            "type": "dql",
            "filterSegments": [],
            "drilldownPath": [],
            "previousFilterSegments": [],
            "state": {
                "input": {
                    "timeframe": {
                        "from": "now()-30m",
                        "to": "now()"
                    },
                    "value": "fetch logs\n| filter k8s.namespace.name == \"astronomy-shop\" and k8s.container.name == \"paymentservice\"\n| sort timestamp desc\n| limit 10\n| fieldsKeep content, loglevel, \"payment.*\", \"content.request.creditCard*\""
                },
                "visualizationSettings": {
                    "chartSettings": {}
                },
                "querySettings": {
                    "maxResultRecords": 1000,
                    "defaultScanLimitGbytes": 500,
                    "maxResultMegaBytes": 1,
                    "defaultSamplingRatio": 10,
                    "enableSampling": false
                },
                "davis": {
                    "includeLogs": true,
                    "davisVisualization": {
                        "isAvailable": true
                    }
                }
            }
        },
        {
            "id": "d3e2a307-c842-468c-9344-56099f76178b",
            "type": "markdown",
            "markdown": "## UH OH, we can see credit card numbers, we need to mask those for compliance reasons. Let's mask the sensitive data in these logs and remove the CC field."
        },
        {
            "id": "34ccb309-0771-4c65-a820-155225a89fd7",
            "type": "dql",
            "filterSegments": [],
            "drilldownPath": [],
            "previousFilterSegments": [],
            "state": {
                "input": {
                    "timeframe": {
                        "from": "now()-30m",
                        "to": "now()"
                    },
                    "value": "fetch logs\n| filter k8s.namespace.name == \"astronomy-shop\" and k8s.container.name == \"paymentservice\"\n| sort timestamp desc\n| limit 10\n| fieldsKeep content, loglevel, content.request.creditCard.creditCardNumber, maskedCreditCardNumber"
                },
                "visualizationSettings": {
                    "chartSettings": {}
                },
                "querySettings": {
                    "maxResultRecords": 1000,
                    "defaultScanLimitGbytes": 500,
                    "maxResultMegaBytes": 1,
                    "defaultSamplingRatio": 10,
                    "enableSampling": false
                },
                "davis": {
                    "includeLogs": true,
                    "davisVisualization": {
                        "isAvailable": true
                    }
                }
            }
        },
        {
            "id": "f8c0eb9c-a32b-402e-9b0e-6bcafb6d22a1",
            "type": "markdown",
            "markdown": "### Finally, lets clean up the logs to a final state we want to keep."
        },
        {
            "id": "426d61d9-777d-4825-b0e3-362207fddbfb",
            "type": "dql",
            "title": "Explore PaymentService logs",
            "queryConfig": {
                "version": "19.0.0",
                "subQueries": [
                    {
                        "id": "A",
                        "isEnabled": true,
                        "datatype": "logs",
                        "filter": "k8s.namespace.name = astronomy-shop k8s.container.name = paymentservice "
                    }
                ],
                "globalCommands": {
                    "limit": 10,
                    "sort": {
                        "field": "timestamp",
                        "direction": "desc"
                    }
                }
            },
            "filterSegments": [],
            "drilldownPath": [],
            "previousFilterSegments": [],
            "previousQueryConfig": {
                "version": "19.0.0",
                "subQueries": [
                    {
                        "id": "A",
                        "isEnabled": true,
                        "datatype": "logs",
                        "filter": "k8s.namespace.name = astronomy-shop k8s.container.name = paymentservice "
                    }
                ],
                "globalCommands": {
                    "limit": 10,
                    "sort": {
                        "field": "timestamp",
                        "direction": "desc"
                    }
                }
            },
            "state": {
                "input": {
                    "timeframe": {
                        "from": "now()-30m",
                        "to": "now()"
                    },
                    "value": "fetch logs\n| filter matchesValue(k8s.namespace.name, \"astronomy-shop\") AND matchesValue(k8s.container.name, \"paymentservice\")\n| sort timestamp desc\n| limit 10"
                },
                "visualizationSettings": {
                    "chartSettings": {}
                },
                "querySettings": {
                    "maxResultRecords": 1000,
                    "defaultScanLimitGbytes": 500,
                    "maxResultMegaBytes": 1,
                    "defaultSamplingRatio": 10,
                    "enableSampling": false
                },
                "davis": {
                    "includeLogs": true,
                    "davisVisualization": {
                        "isAvailable": true
                    }
                }
            }
        },
        {
            "id": "b5f7d6b9-0a39-432d-8360-4ca507407a72",
            "type": "markdown",
            "markdown": "# Business Events"
        },
        {
            "id": "d1baae5f-0f9a-42a4-bd8c-9298656263a1",
            "type": "markdown",
            "markdown": "## Let's review the business data we are capturing when a payment transaction is completed."
        },
        {
            "id": "61404f47-1992-46fb-9d1f-1ea3dce55034",
            "type": "dql",
            "filterSegments": [],
            "drilldownPath": [],
            "previousFilterSegments": [],
            "state": {
                "input": {
                    "timeframe": {
                        "from": "now()-2h",
                        "to": "now()"
                    },
                    "value": "fetch bizevents\n| filter event.type == \"astroshop.paymentservice.transaction.complete\"\n| sort timestamp desc\n| limit 10"
                },
                "visualizationSettings": {
                    "chartSettings": {}
                },
                "querySettings": {
                    "maxResultRecords": 1000,
                    "defaultScanLimitGbytes": 500,
                    "maxResultMegaBytes": 1,
                    "defaultSamplingRatio": 10,
                    "enableSampling": false
                },
                "davis": {
                    "includeLogs": true,
                    "davisVisualization": {
                        "isAvailable": true
                    }
                }
            }
        },
        {
            "id": "71114d38-8ff8-4168-b036-43389fcd9081",
            "type": "markdown",
            "markdown": "## Let's get a total $$ across all payments."
        },
        {
            "id": "2783385d-73df-44b2-91e9-c444438b480b",
            "type": "dql",
            "filterSegments": [],
            "drilldownPath": [],
            "previousFilterSegments": [],
            "state": {
                "input": {
                    "timeframe": {
                        "from": "now()-2h",
                        "to": "now()"
                    },
                    "value": "fetch bizevents\n| filter event.type == \"astroshop.paymentservice.transaction.complete\"\n| summarize total = sum(payment.amount)"
                },
                "visualizationSettings": {
                    "chartSettings": {}
                },
                "querySettings": {
                    "maxResultRecords": 1000,
                    "defaultScanLimitGbytes": 500,
                    "maxResultMegaBytes": 1,
                    "defaultSamplingRatio": 10,
                    "enableSampling": false
                },
                "davis": {
                    "includeLogs": true,
                    "davisVisualization": {
                        "isAvailable": true
                    }
                }
            }
        },
        {
            "id": "266de0bf-6cf9-4f9e-a9ac-952a5ccd2e0c",
            "type": "markdown",
            "markdown": "## There is a currency code, let's get a breakdown by currency code."
        },
        {
            "id": "6fd82dc8-e6fc-48c1-bab7-106c34a70c68",
            "type": "dql",
            "filterSegments": [],
            "drilldownPath": [],
            "previousFilterSegments": [],
            "state": {
                "input": {
                    "timeframe": {
                        "from": "now()-2h",
                        "to": "now()"
                    },
                    "value": "fetch bizevents\n| filter event.type == \"astroshop.paymentservice.transaction.complete\"\n| summarize total = sum(payment.amount), by:{payment.currencycode}"
                },
                "visualizationSettings": {
                    "chartSettings": {}
                },
                "querySettings": {
                    "maxResultRecords": 1000,
                    "defaultScanLimitGbytes": 500,
                    "maxResultMegaBytes": 1,
                    "defaultSamplingRatio": 10,
                    "enableSampling": false
                },
                "davis": {
                    "includeLogs": true,
                    "davisVisualization": {
                        "isAvailable": true
                    }
                }
            }
        },
        {
            "id": "5ad196e7-0748-4149-8044-fd1b004ea1fe",
            "type": "markdown",
            "markdown": "## The business operates in USD, can you convert it to USD using an exchange rate of $1 for any other currency = $0.75USD?"
        },
        {
            "id": "b70ec1d0-e6e6-4f67-b63d-8dbcec24de04",
            "type": "dql",
            "filterSegments": [],
            "drilldownPath": [],
            "previousFilterSegments": [],
            "state": {
                "input": {
                    "timeframe": {
                        "from": "now()-2h",
                        "to": "now()"
                    },
                    "value": "fetch bizevents\n| filter event.type == \"astroshop.paymentservice.transaction.complete\"\n| fieldsAdd Converted = if(payment.currencycode == \"USD\", payment.amount, else:if(payment.currencycode != \"USD\", payment.amount * 0.75))\n| fields payment.currencycode, payment.amount, Converted"
                },
                "visualizationSettings": {
                    "chartSettings": {}
                },
                "querySettings": {
                    "maxResultRecords": 1000,
                    "defaultScanLimitGbytes": 500,
                    "maxResultMegaBytes": 1,
                    "defaultSamplingRatio": 10,
                    "enableSampling": false
                },
                "davis": {
                    "includeLogs": true,
                    "davisVisualization": {
                        "isAvailable": true
                    }
                }
            }
        },
        {
            "id": "1da5dace-155b-46f4-95cc-d94b34b3a1f5",
            "type": "markdown",
            "markdown": "# Let's calculate the total in USD."
        },
        {
            "id": "11e5ffd8-27ce-4f7a-a20b-9b4e164001fe",
            "type": "dql",
            "filterSegments": [],
            "drilldownPath": [],
            "previousFilterSegments": [],
            "state": {
                "input": {
                    "timeframe": {
                        "from": "now()-2h",
                        "to": "now()"
                    },
                    "value": "fetch bizevents\n| filter event.type == \"astroshop.paymentservice.transaction.complete\"\n| fieldsAdd Converted = if(payment.currencycode == \"USD\", payment.amount, else:if(payment.currencycode != \"USD\", payment.amount * 0.75))\n| fields payment.currencycode, payment.amount, Converted\n| summarize total = sum(Converted)"
                },
                "visualizationSettings": {
                    "chartSettings": {}
                },
                "querySettings": {
                    "maxResultRecords": 1000,
                    "defaultScanLimitGbytes": 500,
                    "maxResultMegaBytes": 1,
                    "defaultSamplingRatio": 10,
                    "enableSampling": false
                },
                "davis": {
                    "includeLogs": true,
                    "davisVisualization": {
                        "isAvailable": true
                    }
                }
            }
        },
        {
            "id": "c77f21f1-8938-48dd-975d-1b4d7b6e006d",
            "type": "markdown",
            "markdown": "## Can you identify the top 10 most expensive purchases?"
        },
        {
            "id": "6225addc-6c1c-496e-bd9c-f88a25c98c26",
            "type": "dql",
            "filterSegments": [],
            "drilldownPath": [],
            "previousFilterSegments": [],
            "state": {
                "input": {
                    "timeframe": {
                        "from": "now()-2h",
                        "to": "now()"
                    },
                    "value": "fetch bizevents\n| filter event.type == \"astroshop.paymentservice.transaction.complete\"\n| sort payment.amount desc\n| limit 10"
                },
                "visualizationSettings": {
                    "chartSettings": {}
                },
                "querySettings": {
                    "maxResultRecords": 1000,
                    "defaultScanLimitGbytes": 500,
                    "maxResultMegaBytes": 1,
                    "defaultSamplingRatio": 10,
                    "enableSampling": false
                },
                "davis": {
                    "includeLogs": true,
                    "davisVisualization": {
                        "isAvailable": true
                    }
                }
            }
        },
        {
            "id": "a07ca4fa-f1d0-4bf4-acb2-7f2e0fe25ec1",
            "type": "markdown",
            "markdown": "# Let's also review our custom created metrics from OpenPipeline"
        },
        {
            "id": "31da8844-a053-45fe-ba93-8227d8a70e33",
            "type": "dql",
            "title": "Payments Complete",
            "queryConfig": {
                "version": "19.0.0",
                "subQueries": [
                    {
                        "id": "A",
                        "isEnabled": true,
                        "datatype": "metrics",
                        "metric": {
                            "key": "log.open.astroshop.paymentservice.amount",
                            "aggregation": "avg"
                        },
                        "by": [
                            "CurrencyCode"
                        ],
                        "convertToValue": "Avg",
                        "filter": ""
                    }
                ]
            },
            "filterSegments": [],
            "drilldownPath": [],
            "previousFilterSegments": [],
            "previousQueryConfig": {
                "version": "19.0.0",
                "subQueries": [
                    {
                        "id": "A",
                        "isEnabled": true,
                        "datatype": "metrics",
                        "metric": {
                            "key": "log.open.astroshop.paymentservice.amount",
                            "aggregation": "avg"
                        },
                        "by": [
                            "CurrencyCode"
                        ],
                        "convertToValue": "Avg",
                        "filter": ""
                    }
                ]
            },
            "state": {
                "input": {
                    "timeframe": {
                        "from": "now()-2h",
                        "to": "now()"
                    },
                    "value": "timeseries { avg(log.open.astroshop.paymentservice.amount), value.A = avg(log.open.astroshop.paymentservice.amount, scalar: true) }, by: { CurrencyCode }"
                },
                "visualizationSettings": {
                    "chartSettings": {}
                },
                "querySettings": {
                    "maxResultRecords": 1000,
                    "defaultScanLimitGbytes": 500,
                    "maxResultMegaBytes": 1,
                    "defaultSamplingRatio": 10,
                    "enableSampling": false
                },
                "davis": {
                    "includeLogs": true,
                    "davisVisualization": {
                        "isAvailable": true
                    }
                }
            }
        },
        {
            "id": "67a5a0f4-2128-4e33-a93f-5ac315280dea",
            "type": "dql",
            "title": "Payment Failures",
            "queryConfig": {
                "version": "19.0.0",
                "subQueries": [
                    {
                        "id": "A",
                        "isEnabled": true,
                        "datatype": "metrics",
                        "metric": {
                            "key": "log.open.astroshop.paymentservice.failure",
                            "aggregation": "sum"
                        },
                        "convertToValue": "Avg"
                    }
                ]
            },
            "filterSegments": [],
            "drilldownPath": [],
            "previousFilterSegments": [],
            "previousQueryConfig": {
                "version": "19.0.0",
                "subQueries": [
                    {
                        "id": "A",
                        "isEnabled": true,
                        "datatype": "metrics",
                        "metric": {
                            "key": "log.open.astroshop.paymentservice.failure",
                            "aggregation": "sum"
                        },
                        "convertToValue": "Avg"
                    }
                ]
            },
            "state": {
                "input": {
                    "timeframe": {
                        "from": "now()-2h",
                        "to": "now()"
                    },
                    "value": "timeseries { sum(log.open.astroshop.paymentservice.failure), value.A = avg(log.open.astroshop.paymentservice.failure, scalar: true) }"
                },
                "visualizationSettings": {
                    "chartSettings": {}
                },
                "querySettings": {
                    "maxResultRecords": 1000,
                    "defaultScanLimitGbytes": 500,
                    "maxResultMegaBytes": 1,
                    "defaultSamplingRatio": 10,
                    "enableSampling": false
                },
                "davis": {
                    "includeLogs": true,
                    "davisVisualization": {
                        "isAvailable": true
                    }
                }
            }
        }
    ]
}
